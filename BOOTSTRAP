# Purpose
This document describes how to bootstrap the development and production instances of the fxtrader system

# PreRequisites

## OS

CentOS 8

## SELINUX
    firewall-cmd --permanent --add-port=80/tcp
    yum -y update
    sed -i '/^SELINUX=/c\SELINUX=disabled' /etc/selinux/config
    init 6

## Useful things to have
    yum -y install bind-utils net-tools tmux strace

## git
    yum -y install git
    ssh-keyscan github.com >> ~/.ssh/known_hosts

## Ansible
    yum -y install epel-release
    yum module reset nginx
    yum module enable nginx:1.20
    yum -y install ansible python3-docker
    chmod o+rx /root # This is necessary in development only so that nginx can read and serve the files from /root/src/fxhistoricaldata_website_static.  The prod version is served via github pages.
    mkdir ~/src && cd ~/src
    #git clone git@github.com:fx-trader/fx-ansible.git
    git clone https://github.com/fx-trader/fx-ansible.git
    cd ~/src/fx-ansible/extensions/setup
    ./role_update.sh
    cd ~/src/fx-ansible
    echo $VAULT_PASS > .vpass
    cd ~/src/fx-ansible/plays
    ansible-playbook -i ../environments/development fx.yml

# Get some personal config files
    git clone https://github.com/joaocosta/home.git ~/src/home
    cp ~/src/home/.bash_aliases ~  #Edit and change fxdata password
    cp ~/src/home/.gitconfig ~
    cp ~/src/home/.vimrc ~
    cp ~/src/home/.tmux.conf ~

# Source code repos

    cd ~/src
    REPOS="fx-trader/Finance-API-Data fx-trader/Finance-HostedTrader fx-trader/Finance-snipers fx-trader/fxhistoricaldata_website_static fx-trader/snipers-api mysqludf/lib_mysqludf_ta"
    for repo in $REPOS; do
        git clone git@github.com:${repo}.git
    done

# Create token file

    echo $TOKEN > ~/fx/cfg/oanda.token
    chmod 600 ~/fx/cfg/oanda.token


# Database

The database instance runs inside a docker container. It includes a mysql udf binary optimised to run finance calculations (https://github.com/jo#

## Populate data
    fx-shell
    /usr/local/bin/fx-download.pl --timeframes=60 --numItems=150000 --verbose
    exit



# Snipers

## Create database schema

    docker run --rm --link snipers-db:snipers-db fxtrader/snipers-api ruby /webapp/db/schema.rb

# Get fxhistoricaldata static website
    cd ~/src
    #git clone https://github.com/fx-trader/fxhistoricaldata_website_static.git
    git clone git@github.com:fx-trader/fxhistoricaldata_website_static.git

---

# HOWTO

## MySql client shell
    docker run  -it --rm \
                --link fxdata:mysql \
                mariadb \
                sh -c 'exec mysql -h"$MYSQL_PORT_3306_TCP_ADDR" -P"$MYSQL_PORT_3306_TCP_PORT" -uroot -p"$MYSQL_ENV_MYSQL_ROOT_PASSWORD"'

## Dev container
make sure mydevapi.fxhistoricaldata.com is mapped to the VM in /etc/hosts
Access at http://mydevapi.fxhistoricaldata.com/indicator?t=5minute&e=ema(close,200)&s=XAGUSD&d=5&l=10000.

docker run  --rm \
            -ti \
            -v /root/src:/src \
            -v /root/fx/cfg:/etc/fxtrader \
            -v /usr/share/nginx/html/fxapi:/public_html \
            -e PERL5LIB=/src/Finance-HostedTrader/lib \
            -e PATH=/src/Finance-HostedTrader/bin:/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/root/bin \
            -p 5002:5000 \
            --link fxdata:fxdata \
            fxtrader/finance-api-data \
            bash # Then run plackup /src/Finance-API-Data/bin/app.psgi


## Optimize mariadb tables

    docker exec -ti fxapi-data bash
    time fx-all-tables.pl --timeframes=60 --template="REPAIR TABLE TABLE_NAME;" | fx-db-client.pl.
    time fx-all-tables.pl --timeframes=60 --template="OPTIMIZE TABLE TABLE_NAME;" | fx-db-client.pl.
