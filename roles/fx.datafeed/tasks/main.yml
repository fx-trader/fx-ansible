---
# tasks file for fx.datafeed

- name: Create datafeed mariadb directories
  file:
    path:  "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: 0755
  with_items:
    - "{{ datafeed['cfgdir'] }}"
    - "{{ datafeed['datadir'] }}"

- name: Setup datafeed mariadb config files
  copy:
    src: "mariadb/{{ item }}"
    dest: "{{ datafeed['cfgdir'] }}/{{item}}"
    owner: root
    group: root
    mode: 0644
  with_items:
    - mysqld_safe_syslog.cnf
    - fxtrader.cnf

- name: Download {{role_path|basename}} mysqludf/ta
  docker_image:
    name: mysqludf/ta

- name: fxdatafeed container
  docker_container:
    name: fxdatafeed
    image: mysqludf/ta
    volumes:
      - "{{datafeed['datadir']}}:/var/lib/mysql"
      - "{{datafeed['cfgdir']}}:/etc/mysql/conf.d"
      - "{{fx['srcdir']}}:/root/src"
    hostname: data
    state: started
    env:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: "{{ fx['datafeed']['dbname'] }}"
      MYSQL_USER: "{{ fx['datafeed']['dbuser'] }}"
      MYSQL_PASSWORD: "{{ fx['datafeed']['dbpass'] }}"

- name: Download {{role_path|basename}} fxtrader/finance-hostedtrader
  docker_image:
    name: fxtrader/finance-hostedtrader

- name: fxdatafeed schema
  docker_container:
    name: fxdatafeedschema
    image: fxtrader/finance-hostedtrader
    volumes:
      - "{{fx['cfgdir']}}:/etc/fxtrader"
    links:
      - fxdatafeed:fxdatafeed
    command: "/bin/bash -c 'fx-create-db-schema.pl | fx-db-client.pl'"
    state: started

- name: fxfeed container
  docker_container:
    name: fxcmfeed
    image: fxtrader/finance-hostedtrader
    volumes:
      - "{{fx['cfgdir']}}:/etc/fxtrader"
    links:
      - fxdatafeed:fxdatafeed
    command: "fx-download-fxcm.pl --verbose --timeframes=300 --numItems=15"
    state: present

- name: fxcm data download cronjob
  copy:
    src: cron.d/fxcm_download_data
    dest: /etc/cron.d/fxcm_download_data
    owner: root
    group: root
    mode: 0644
